<div id="comment-sidebar" class="comment-sidebar">
  <button onclick="toggleSidebar()" class="sidebar-toggle">
    <span style="font-size: 1.2em;">ðŸ’¬</span>
  </button>

  <div class="sidebar-content">
    <div class="sidebar-header">
      <h4>Recent Comments</h4>
      <button onclick="toggleSidebar()" class="close-btn">&times;</button>
    </div>
    
    <ul class="comment-list">
    {% if site.data.recent_comments.data.repository.discussions.nodes %}
      {% for discussion in site.data.recent_comments.data.repository.discussions.nodes %}
        
        {% assign base_link = discussion.url %} 
        {% for post in site.posts %}
          {% if post.url contains discussion.title or discussion.title contains post.url %}
            {% assign base_link = post.url | relative_url %}
            {% break %}
          {% endif %}
        {% endfor %}

        {% for comment in discussion.comments.nodes reversed %}
          <li class="comment-item">
            <img src="{{ comment.author.avatarUrl }}" alt="{{ comment.author.login }}" class="comment-avatar">
            <div class="comment-details">
              <span class="comment-author">{{ comment.author.login }}</span>
              <span class="comment-context"> on </span>
              <a href="{{ base_link }}#discussioncomment-{{ comment.databaseId }}" class="comment-link">
                {{ discussion.title | truncate: 30 }}
              </a>
              <p class="comment-snippet">"{{ comment.bodyText | truncate: 60 }}"</p>
            </div>
          </li>

          {% if comment.replies.nodes %}
            {% for reply in comment.replies.nodes %}
            <li class="comment-item reply-item">
              <div class="reply-indicator">â†³</div>
              <img src="{{ reply.author.avatarUrl }}" alt="{{ reply.author.login }}" class="comment-avatar small">
              <div class="comment-details">
                <span class="comment-author">{{ reply.author.login }}</span>
                <span class="comment-context"> replied:</span>
                <a href="{{ base_link }}#discussioncomment-{{ reply.databaseId }}" class="comment-link" style="font-weight: normal;">
                  ...
                </a>
                <p class="comment-snippet">"{{ reply.bodyText | truncate: 50 }}"</p>
              </div>
            </li>
            {% endfor %}
          {% endif %}

        {% endfor %}
        
      {% endfor %}
    {% else %}
      <li style="padding: 20px; text-align: center; color: #777;">Loading recent comments...</li>
    {% endif %}
    </ul>
  </div>
</div>

<style>
  /* --- Container & Layout --- */
  .comment-sidebar { position: fixed; right: 0; top: 20%; z-index: 9999; display: flex; align-items: flex-start; transform: translateX(320px); transition: transform 0.3s ease; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
  .comment-sidebar.open { transform: translateX(0); }
  .sidebar-toggle { background: #008AFF; color: white; border: none; padding: 15px 10px; cursor: pointer; border-radius: 5px 0 0 5px; box-shadow: -2px 2px 5px rgba(0,0,0,0.2); }
  .sidebar-content { width: 320px; background: #fff; border: 1px solid #ddd; box-shadow: -5px 0 25px rgba(0,0,0,0.15); height: auto; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column; }
  
  /* --- Header --- */
  .sidebar-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; }
  .sidebar-header h4 { margin: 0; font-size: 16px; font-weight: 700; color: #333; }
  .close-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: #666; }
  
  /* --- List & Items --- */
  .comment-list { list-style: none; padding: 0; margin: 0; }
  .comment-item { display: flex; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; }
  .comment-item:hover { background: #fbfbfb; }

  /* --- Replies --- */
  .reply-item { background-color: #fafafa; padding-left: 15px; border-bottom: 1px solid #eee; }
  .reply-indicator { color: #ccc; margin-right: 6px; font-size: 1.2em; line-height: 1; }
  .comment-avatar.small { width: 24px; height: 24px; margin-right: 8px; }
  
  /* --- Typography & Avatars --- */
  .comment-avatar { width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; border: 1px solid #eee; object-fit: cover; }
  .comment-details { flex: 1; font-size: 13px; line-height: 1.4; overflow: hidden; }
  .comment-author { font-weight: 700; color: #333; }
  .comment-context { color: #888; font-size: 0.9em; }
  
  .comment-link { font-weight: 600; color: #008AFF; text-decoration: none; display: block; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .comment-link:hover { text-decoration: underline; }
  
  .comment-snippet { margin: 0; color: #555; font-style: italic; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
</style>

<script>
  function toggleSidebar() {
    document.getElementById('comment-sidebar').classList.toggle('open');
  }
</script>