{% if site.giscus.repository and site.giscus.hostname %}
<div class="giscus-comments">
  
  <div style="background: #f9f9f9; border-left: 4px solid #008AFF; padding: 10px; margin-bottom: 20px; font-size: 0.9em; color: #555; border-radius: 0 4px 4px 0;">
    <strong>Note:</strong> Latex can be input as $x$ with no spaces ($ x $ will not work). To edit or delete your comment, click the 
    <strong>timestamp</strong> (e.g., "5 minutes ago") to manage it directly on GitHub.
  </div>

  <div class="giscus"></div>
  
  <script src="https://{{ site.giscus.hostname }}/client.js"
          data-repo="{{ site.giscus.repository }}"
          data-repo-id="{{ site.giscus.repository-id }}"
          data-category="{{ site.giscus.category }}"
          data-category-id="{{ site.giscus.category-id }}"
          data-mapping="{{ site.giscus.mapping }}"
          data-reactions-enabled="{{ site.giscus.reactions-enabled }}"
          data-emit-metadata="{{ site.giscus.emit-metadata }}"
          data-input-position="bottom"
          data-theme="{{ site.giscus.theme }}"
          data-lang="en"
          crossorigin="anonymous"
          async>
  </script>

  <script>
    (function() {
      function getGiscusIframe() {
        return document.querySelector('iframe.giscus-frame');
      }

      function syncHash() {
        const iframe = getGiscusIframe();
        if (!iframe) return;
        
        // FIXED: We look for 'discussioncomment' (no hyphen)
        if (window.location.hash && window.location.hash.includes('discussioncomment')) {
          try {
            const url = new URL(iframe.src);
            url.hash = window.location.hash;
            
            // Force the Iframe to reload with the anchor
            iframe.src = url.toString();
          } catch (e) {
            console.error("Could not sync Giscus hash:", e);
          }
        }
      }

      // Listen for clicks on the sidebar (hash changes)
      window.addEventListener('hashchange', syncHash);

      // Listen for the page loading (wait for Giscus to be ready)
      window.addEventListener('message', function(event) {
        if (event.origin === 'https://giscus.app' && 
            event.data && 
            event.data.giscus && 
            event.data.giscus.resizeHeight) {
          // Wait 0.5s for the iframe to settle, then scroll
          setTimeout(syncHash, 500);
        }
      });
    })();
  </script>
</div>
{% endif %}