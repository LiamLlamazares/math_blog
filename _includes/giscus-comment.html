{% if site.giscus.repository and site.giscus.hostname %}
<div class="giscus-comments">
  
  <div style="background: #f9f9f9; border-left: 4px solid #008AFF; padding: 10px; margin-bottom: 20px; font-size: 0.9em; color: #555; border-radius: 0 4px 4px 0;">
    <strong>Note:</strong> Latex can be input as &#36;x&#36; with no spaces (&#36; x &#36; will not work). To edit or delete your comment, click the 
    <strong>timestamp</strong> (e.g., "5 minutes ago") to manage it directly on GitHub.
  </div>

  <div class="giscus" id="giscus-container"></div>
  
  <script src="https://{{ site.giscus.hostname }}/client.js"
          data-repo="{{ site.giscus.repository }}"
          data-repo-id="{{ site.giscus.repository-id }}"
          data-category="{{ site.giscus.category }}"
          data-category-id="{{ site.giscus.category-id }}"
          data-mapping="{{ site.giscus.mapping }}"
          data-reactions-enabled="{{ site.giscus.reactions-enabled }}"
          data-emit-metadata="{{ site.giscus.emit-metadata }}"
          data-input-position="bottom"
          data-theme="{{ site.giscus.theme }}"
          data-lang="en"
          crossorigin="anonymous"
          async>
  </script>

  <script>
    (function() {
      function handleDeepLink() {
        // 1. Check if the URL has a comment hash
        const hash = window.location.hash;
        if (!hash || !hash.includes('discussioncomment')) return;

        // 2. Scroll the Main Page down to the comments section
        // This fixes the issue of "staying at the top"
        const container = document.getElementById('giscus-container');
        if (container) {
          container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 3. Force the Iframe to load the specific comment
        const iframe = document.querySelector('iframe.giscus-frame');
        if (iframe) {
          try {
            const url = new URL(iframe.src);
            // Only reload if the hash is actually different
            if (url.hash !== hash) {
              url.hash = hash;
              iframe.src = url.toString();
            }
          } catch (e) { console.error(e); }
        }
      }

      // Run on initial load
      window.addEventListener('load', handleDeepLink);
      
      // Run when the user clicks a sidebar link (hash change)
      window.addEventListener('hashchange', handleDeepLink);

      // Run when Giscus says "I'm ready" (backup)
      window.addEventListener('message', function(event) {
        if (event.origin === 'https://giscus.app' && 
            event.data && 
            event.data.giscus && 
            event.data.giscus.resizeHeight) {
          setTimeout(handleDeepLink, 500);
        }
      });
    })();
  </script>
</div>
{% endif %}