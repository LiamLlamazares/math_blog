name: Fetch Recent Comments
on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch: # Allows you to click "Run" manually

permissions:
  contents: write

jobs:
  update-comments:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Fetch Comments via GraphQL
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          CATEGORY_ID: "DIC_kwDOHZYcTc4Cx-sY" 
        run: |
          gh api graphql -f query='
            query($owner: String!, $name: String!, $categoryId: ID!) {
              repository(owner: $owner, name: $name) {
                discussions(first: 10, categoryId: $categoryId, orderBy: {field: UPDATED_AT, direction: DESC}) {
                  nodes {
                    title
                    url
                    comments(last: 10) {
                      nodes {
                        databaseId   # <--- NEW: We need this ID number
                        author { login avatarUrl }
                        bodyText
                        createdAt
                        url
                        replies(last: 3) {
                          nodes {
                            databaseId  # <--- NEW: We need this for replies too
                            author { login avatarUrl }
                            bodyText
                            createdAt
                            url
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' -F owner="${REPO%/*}" -F name="${REPO#*/}" -F categoryId="$CATEGORY_ID" > _data/recent_comments.json
            
      - name: Commit and Push changes
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          # Create directory if it doesn't exist
          mkdir -p _data
          git add _data/recent_comments.json
          # Only commit if there are changes to avoid empty commits
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update recent comments" && git push)